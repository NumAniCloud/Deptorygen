# インスタンスの生成手段を細かくカスタマイズする

古典的なDIコンテナでは、インスタンスを生成する際の処理をカスタマイズする機能があります。
例えばGenericHostのDIコンテナ機能では、
生成したい型を登録する際にデリゲートを渡して細かい生成手順を指示することができます。

Deptorygenでも、インスタンスの生成方法を細かくカスタマイズしたファクトリーを実装することができます。
ファクトリー定義として用意したインターフェースは、プログラマーが手動で実装してもかまいませんので、
手動で実装したファクトリークラスを別のファクトリーがキャプチャすることで実現します。

以下はユーザーの書くコードです。

```csharp
using System;
using Deptorygen.Annotations;
using UseDeptorygen.Infra;

namespace UseDeptorygen.Samples.CustomResolution
{
	class Client
	{
		private readonly IService _service;
		private readonly Dependency _dependency;

		public Client(IService service, Dependency dependency)
		{
			_service = service;
			_dependency = dependency;
		}

		public void Invoke()
		{
			Console.WriteLine("# Client");
			_service.Run();
			_dependency.Hoge();
		}
	}

	interface IService
	{
		void Run();
	}

	class ServiceGold : IService
	{
		public void Run()
		{
			Console.WriteLine("This is gold.");
		}
	}

	class Dependency
	{
		public void Hoge()
		{
			Console.WriteLine("It is dependency.");
		}
	}

	[Factory]
	interface IFactory
	{
		ICustomFactory Custom { get; }

		IService ResolveService();
		Client ResolveClient();
	}

	[Factory]
	interface ICustomFactory
	{
		IService ResolveService();
		Dependency ResolveDependency();
	}

	class MyCustomFactory : ICustomFactory
	{
		public Dependency ResolveDependency()
		{
			Console.WriteLine("Creating Dependency!");
			return new Dependency();
		}

		public IService ResolveService()
		{
			Console.WriteLine("Creating Service!");
			return new ServiceGold();
		}
	}

	class CustomResolutionSample : ISample
	{
		public void Run()
		{
			var factory = new Factory(new MyCustomFactory());
			factory.ResolveClient().Invoke();
		}
	}
}
```

`Client`クラスは`IService`,`Dependency`に依存していて、
`IService`に対して`ServiceGold`という実装が存在します。

`IFactory`は`ICustomFactory`をキャプチャしていて、
`ICustomFactory`に対して`MyCustomFactory`をキャプチャしています。

`MyCustomFactory`はファクトリーとして利用されるときにログを画面に出力します。

```csharp
// <autogenerated />
#nullable enable
using System;
using System.Collections.Generic;

namespace UseDeptorygen.Samples.CustomResolution
{
	internal partial class Factory : IFactory
		, IDisposable
	{
		public ICustomFactory Custom { get; }

		private Client? _ResolveClientCache;

		public Factory(ICustomFactory custom)
		{
			Custom = custom;
		}

		public IService ResolveService()
		{
			return Custom.ResolveService();
		}

		public Client ResolveClient()
		{
			return _ResolveClientCache ??= new Client(Custom.ResolveService(), Custom.ResolveDependency());
		}

		public void Dispose()
		{
		}
	}
}
```

```txt
Creating Service!
Creating Dependency!
# Client
This is gold.
It is dependency.
```

`Factory`クラスにはユーザーがカスタマイズしたファクトリーをキャプチャを利用して注入したので、
インスタンスの生成時にログを出力するなどの細かい制御を行うことができます。
