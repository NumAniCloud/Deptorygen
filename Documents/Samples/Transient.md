# 生成時にキャッシュしないようにしたい

ファクトリーから取得したいオブジェクトは、キャッシュしてほしいものばかりではありません。キャッシュを伴わずに依存関係を解決するオプションが用意されています。

以下はユーザーの書くコードです。

```csharp
using System;
using Deprovgen.Annotations;
using UseDeprovgen.Infra;

namespace UseDeprovgen.Samples.Transient
{
	// このクラスが依存関係解決時にキャッシュされないことを確かめたい
	class Service
	{
		private static int NextId = 0;

		private int Id { get; }

		public Service()
		{
			Id = NextId++;
		}

		public void Invoke()
		{
			Console.WriteLine($"This is Service #{Id}.");
		}
	}

	class Client
	{
		private readonly Service _serviceA;
		private readonly Service _serviceB;

		public Client(Service serviceA, Service serviceB)
		{
			_serviceA = serviceA;
			_serviceB = serviceB;
		}

		public void Say()
		{
			// キャッシュされていなければ、2つのオブジェクトは互いに異なるIDを表示するはず
			_serviceA.Invoke();
			_serviceB.Invoke();
		}
	}

	// ファクトリー定義
	[Factory]
	interface IFactory
	{
		// 解決メソッドの名前の末尾を "AsTransient" にするとキャッシュしないようになる
		Service ResolveServiceAsTransient();
		Client ResolveClient();
	}

	class TransientSample : ISample
	{
		public void Run()
		{
			var factory = new Factory();
			factory.ResolveClient().Say();
			factory.Dispose();
		}
	}
}
```

以下は生成されるコードです。

```csharp
// <autogenerated />
using System;
using System.Collections.Generic;

namespace UseDeprovgen.Samples.Transient
{
    internal partial class Factory : IFactory
        , IDisposable
    {

        private Client? _ResolveClientCache;

        public Factory()
        {
        }

        public Service ResolveServiceAsTransient()
        {
            return new Service();
        }

        public Client ResolveClient()
        {
            return _ResolveClientCache ??= new Client(ResolveServiceAsTransient(), ResolveServiceAsTransient());
        }


        
        public void Dispose()
        {
        }
    }
}
```

実行結果は以下の通りです。

```
This is Service #0.
This is Service #1.
```

キャッシュするかどうかを、解決メソッドに対して属性を書くことで指定したい場合もあるかと思いますが、
メソッド名はファクトリーを使用するプログラマーにとって重要であり、
キャッシュをするのかどうかは常に名前から判別できるようDeprovgenは強制しています。

この機能が備わっている都合上、名前の末尾が `AsTransient` であるようなクラスの解決メソッドを定義したい場合、
 `ResolveXXXAsTransientInstance` などというように `AsTransient` の後に別の文字を足さない限り、
インスタンスはキャッシュしないものとしてコード生成が実行されてしまいますのでご注意ください。
