# コンストラクタで意外な引数を要求されるケース

Deptorygenで生成されたファクトリークラスは、
そのコンストラクタ引数がどのような内容になるのかをDeptorygenが決めます。
これはそれ以外のメソッドの引数をプログラマーが決めることになっているのと対照的です。

どのような場合にどのようなインスタンスがコンストラクタ引数を通じて要求されるのかを、このページで解説します。

## Case1. 2つのクラス間の依存関係を解決したい

いま、`Service`クラスと`Client`クラスがあり、`Client`クラスを生成するために`Service`クラスが必要です。
これは[基本的な使い方](./BasicStyle.md)のページと同じです。

```csharp
using System;

namespace UseDeptorygen.Guides.Constructor
{
	class Service
	{
		public void Do()
		{
			Console.WriteLine("Done.");
		}
	}

	class Client
	{
		private readonly Service _service;

		public Client(Service service)
		{
			_service = service;
		}

		public void Do()
		{
			Console.WriteLine("Doing.");
			_service.Do();
		}
	}
}
```

これに対して、以下のようなファクトリー定義を作成しました。
ここで、このファクトリー定義を書いたプログラマーは、`Service`クラスのための解決メソッドをうっかり書き忘れたものと考えてください。

```csharp
using Deptorygen.Annotations;

namespace UseDeptorygen.Guides.Constructor
{
	[Factory]
	interface IFactory
	{
		Client ResolveClient();
	}
}
```

これを元にファクトリークラスを生成すると、以下のようなものが得られます。

```csharp
// <autogenerated />
#nullable enable
using System;
using System.Collections.Generic;

namespace UseDeptorygen.Guides.Constructor
{
	internal partial class Factory : IFactory
		, IDisposable
	{
		private readonly Service _service;

		private Client? _ResolveClientCache;

		public Factory(Service service)
		{
			_service = service;
		}

		public Client ResolveClient()
		{
			return _ResolveClientCache ??= new Client(_service);
		}

		public void Dispose()
		{
		}
	}
}
```

`Client`の生成に必要な`Service`を生成するメソッドをこのクラスは持っていませんが、
ファクトリークラスは`Service`のインスタンスをコンストラクタ引数を通じて要求し、
そうして得られたインスタンスを用いて`Client`のインスタンスを生成しています。

このように、ファクトリー自身が解決すべきクラスの依存先を自分で生成できない場合、
ファクトリーはコンストラクタ引数を通じてそのインスタンスをプログラマーに要求します。

この状態は、`Factory`クラスをnewで生成する場合に不便です。
なぜなら、`Factory`のコンストラクタに渡す`Service`をプログラマーが自分で生成しなければならないからです。
以下のように：

```csharp
var factory = new Factory(new Service());
```

もしここで、ファクトリー定義に`Service`を生成するメソッドの定義を追加したならば、このコンストラクタ引数は次にコード生成をするタイミングで消えます。

Deptorygenでは、インスタンスを生成するために足りないオブジェクトがある場合、
コンストラクタ引数を通じて利用者に要求します。
なので、プログラマーはファクトリークラスのコンストラクタ引数を見ることで、
ファクトリー定義に足りない定義があるかどうか、それはどんなインスタンスなのかを確認することができます。

もちろん、コンストラクタで追加のインスタンスを要求されるままにしておく場合もあります。

## Case2. キャプチャを利用する

